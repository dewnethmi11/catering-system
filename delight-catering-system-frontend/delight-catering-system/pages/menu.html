<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Management - Delight Catering</title>
</head>
<body>
    <div class="content-header">
        <h2>Menu Management</h2>
        <p>Manage food items, categories, and pricing</p>
    </div>

    <!-- Category Filter and Search -->
    <div class="card">
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <input 
                type="text" 
                id="searchMenu" 
                class="form-control" 
                placeholder="Search menu items..."
                style="flex: 1; min-width: 250px;"
                onkeyup="handleSearch()"
            >
            <select class="form-control" style="width: 200px;" onchange="filterByCategory(this.value)">
                <option value="">All Categories</option>
                <option value="STARTER">Starter</option>
                <option value="MAIN_COURSE">Main Course</option>
                <option value="DESSERT">Dessert</option>
                <option value="BEVERAGE">Beverage</option>
                <option value="SIDE_DISH">Side Dish</option>
                <option value="SOUP">Soup</option>
                <option value="SALAD">Salad</option>
            </select>
            <select class="form-control" style="width: 200px;" onchange="filterByDietary(this.value)">
                <option value="">All Items</option>
                <option value="vegetarian">Vegetarian</option>
                <option value="vegan">Vegan</option>
                <option value="glutenFree">Gluten-Free</option>
                <option value="available">Available Only</option>
            </select>
            <button class="btn btn-primary" onclick="openAddMenuItemModal()">➕ Add Menu Item</button>
            <button class="btn btn-secondary" onclick="loadMenuItems()">🔄 Refresh</button>
        </div>
    </div>

    <!-- Menu Items Table -->
    <div class="card">
        <h3 class="card-title">Menu Items</h3>
        <div id="loadingMessage" style="text-align: center; padding: 40px; display: none;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #666;">Loading menu items...</p>
        </div>
        <div id="errorMessage" style="display: none; padding: 20px; background: #ffebee; color: #c62828; border-radius: 8px; margin-bottom: 20px;"></div>
        <div style="overflow-x: auto;">
            <table id="menuTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Prep Time</th>
                        <th>Dietary</th>
                        <th>Availability</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="menuTableBody">
                    <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Menu Item Modal -->
    <div id="menuItemModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 10px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modalTitle">Add New Menu Item</h3>
                <button onclick="closeMenuItemModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <form id="menuItemForm">
                <input type="hidden" id="itemId">
                
                <div class="form-group">
                    <label>Item Name *</label>
                    <input type="text" id="itemName" class="form-control" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="category" class="form-control" required>
                            <option value="STARTER">Starter</option>
                            <option value="MAIN_COURSE">Main Course</option>
                            <option value="DESSERT">Dessert</option>
                            <option value="BEVERAGE">Beverage</option>
                            <option value="SIDE_DISH">Side Dish</option>
                            <option value="SOUP">Soup</option>
                            <option value="SALAD">Salad</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Price (Rs) *</label>
                        <input type="number" id="price" class="form-control" step="0.01" min="0.01" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Ingredients</label>
                    <textarea id="ingredients" class="form-control" rows="2" placeholder="e.g., Chicken, Tomatoes, Garlic, Herbs"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Preparation Time (minutes)</label>
                        <input type="number" id="preparationTimeMinutes" class="form-control" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Image URL</label>
                        <input type="text" id="imageUrl" class="form-control" placeholder="https://...">
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 10px;">Dietary Information</label>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="vegetarian"> Vegetarian
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="vegan"> Vegan
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="glutenFree"> Gluten-Free
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="available" checked> Available
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <span id="submitBtnText">Create Menu Item</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeMenuItemModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allMenuItems = [];
        let filteredMenuItems = [];
        let currentEditId = null;

        // Load menu items on page load
        // window.addEventListener('DOMContentLoaded', function() {
        //     loadMenuItems();
        // });
        // Call immediately - no need for DOMContentLoaded in dynamically loaded pages
        setTimeout(function() {
            if (typeof getAllUsersAPI === 'function') {
                loadMenuItems();
            } else {
                console.error('API functions not loaded yet');
            }
        }, 100);

        // Load all menu items
        async function loadMenuItems() {
            showLoading(true);
            hideError();
            
            try {
                allMenuItems = await getAllMenuItemsAPI();
                filteredMenuItems = [...allMenuItems];
                renderMenuItems();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Failed to load menu items');
            }
        }

        // Render menu items table
        function renderMenuItems() {
            const tbody = document.getElementById('menuTableBody');
            tbody.innerHTML = '';

            if (filteredMenuItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No menu items found</td></tr>';
                return;
            }

            filteredMenuItems.forEach(item => {
                const dietaryTags = [];
                if (item.vegetarian) dietaryTags.push('🥬 Veg');
                if (item.vegan) dietaryTags.push('🌱 Vegan');
                if (item.glutenFree) dietaryTags.push('🌾 GF');

                const row = `
                    <tr>
                        <td>${item.id}</td>
                        <td><strong>${item.name}</strong></td>
                        <td><span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${item.category.replace('_', ' ')}</span></td>
                        <td>Rs:${parseFloat(item.price).toFixed(2)}</td>
                        <td>${item.preparationTimeMinutes || 'N/A'} min</td>
                        <td>${dietaryTags.length > 0 ? dietaryTags.join(' ') : '-'}</td>
                        <td>
                            <span style="color: ${item.available ? 'green' : 'red'};">●</span> 
                            ${item.available ? 'Available' : 'Unavailable'}
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; margin-right: 5px;" onclick="editMenuItem(${item.id})">
                                Edit
                            </button>
                            <button class="btn ${item.available ? 'btn-secondary' : 'btn-primary'}" style="padding: 5px 10px; margin-right: 5px;" onclick="toggleItemAvailability(${item.id})">
                                ${item.available ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteMenuItem(${item.id})">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Handle search
        function handleSearch() {
            const searchTerm = document.getElementById('searchMenu').value.toLowerCase();
            
            if (searchTerm === '') {
                loadMenuItems();
            } else {
                searchMenuItems(searchTerm);
            }
        }

        // Search menu items via API
        async function searchMenuItems(searchTerm) {
            showLoading(true);
            hideError();
            
            try {
                filteredMenuItems = await searchMenuItemsAPI(searchTerm);
                renderMenuItems();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Search failed');
            }
        }

        // Filter by category
        async function filterByCategory(category) {
            showLoading(true);
            hideError();
            
            try {
                if (category === '') {
                    filteredMenuItems = await getAllMenuItemsAPI();
                } else {
                    filteredMenuItems = await getMenuItemsByCategoryAPI(category);
                }
                renderMenuItems();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Filter failed');
            }
        }

        // Filter by dietary options
        async function filterByDietary(option) {
            showLoading(true);
            hideError();
            
            try {
                switch(option) {
                    case 'vegetarian':
                        filteredMenuItems = await getVegetarianItemsAPI();
                        break;
                    case 'vegan':
                        filteredMenuItems = await getVeganItemsAPI();
                        break;
                    case 'glutenFree':
                        filteredMenuItems = await getGlutenFreeItemsAPI();
                        break;
                    case 'available':
                        filteredMenuItems = await getAvailableMenuItemsAPI();
                        break;
                    default:
                        filteredMenuItems = await getAllMenuItemsAPI();
                }
                renderMenuItems();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Filter failed');
            }
        }

        // Open add menu item modal
        function openAddMenuItemModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add New Menu Item';
            document.getElementById('submitBtnText').textContent = 'Create Menu Item';
            document.getElementById('menuItemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('available').checked = true;
            document.getElementById('menuItemModal').style.display = 'flex';
        }

        // Close menu item modal
        function closeMenuItemModal() {
            document.getElementById('menuItemModal').style.display = 'none';
            document.getElementById('menuItemForm').reset();
            currentEditId = null;
        }

        // View menu item details
        async function viewMenuItem(itemId) {
            try {
                const item = await getMenuItemByIdAPI(itemId);
                
                const details = `
Menu Item Details
================
ID: ${item.id}
Name: ${item.name}
Category: ${item.category.replace('_', ' ')}
Price: Rs:${parseFloat(item.price).toFixed(2)}

Description:
${item.description || 'No description provided'}

Ingredients:
${item.ingredients || 'Not specified'}

Preparation Time: ${item.preparationTimeMinutes || 'Not specified'} minutes

Dietary Information:
-------------------
Vegetarian: ${item.vegetarian ? 'Yes' : 'No'}
Vegan: ${item.vegan ? 'Yes' : 'No'}
Gluten-Free: ${item.glutenFree ? 'Yes' : 'No'}

Availability: ${item.available ? 'Available' : 'Not Available'}
Image URL: ${item.imageUrl || 'No image'}
                `;
                alert(details);
            } catch (error) {
                alert('Failed to load menu item details: ' + error.message);
            }
        }

        // Edit menu item
        async function editMenuItem(itemId) {
            try {
                const item = await getMenuItemByIdAPI(itemId);
                
                currentEditId = itemId;
                document.getElementById('modalTitle').textContent = 'Edit Menu Item';
                document.getElementById('submitBtnText').textContent = 'Update Menu Item';
                document.getElementById('itemId').value = item.id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('category').value = item.category;
                document.getElementById('price').value = item.price;
                document.getElementById('description').value = item.description || '';
                document.getElementById('ingredients').value = item.ingredients || '';
                document.getElementById('preparationTimeMinutes').value = item.preparationTimeMinutes || '';
                document.getElementById('imageUrl').value = item.imageUrl || '';
                document.getElementById('vegetarian').checked = item.vegetarian;
                document.getElementById('vegan').checked = item.vegan;
                document.getElementById('glutenFree').checked = item.glutenFree;
                document.getElementById('available').checked = item.available;
                
                document.getElementById('menuItemModal').style.display = 'flex';
            } catch (error) {
                alert('Failed to load menu item details: ' + error.message);
            }
        }

        // Handle form submission
        document.getElementById('menuItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const menuItemData = {
                name: document.getElementById('itemName').value.trim(),
                category: document.getElementById('category').value,
                price: parseFloat(document.getElementById('price').value),
                description: document.getElementById('description').value.trim(),
                ingredients: document.getElementById('ingredients').value.trim(),
                preparationTimeMinutes: parseInt(document.getElementById('preparationTimeMinutes').value) || null,
                imageUrl: document.getElementById('imageUrl').value.trim(),
                vegetarian: document.getElementById('vegetarian').checked,
                vegan: document.getElementById('vegan').checked,
                glutenFree: document.getElementById('glutenFree').checked,
                available: document.getElementById('available').checked
            };

            const submitBtn = document.querySelector('#menuItemForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';

            try {
                if (currentEditId) {
                    await updateMenuItemAPI(currentEditId, menuItemData);
                    alert('Menu item updated successfully!');
                } else {
                    await createMenuItemAPI(menuItemData);
                    alert('Menu item created successfully!');
                }
                
                closeMenuItemModal();
                loadMenuItems();
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = currentEditId ? 'Update Menu Item' : 'Create Menu Item';
            }
        });

        // Toggle item availability
        async function toggleItemAvailability(itemId) {
            try {
                await toggleMenuItemAvailabilityAPI(itemId);
                alert('Menu item availability updated!');
                loadMenuItems();
            } catch (error) {
                alert('Failed to update availability: ' + error.message);
            }
        }

        // Delete menu item
        async function deleteMenuItem(itemId) {
            if (!confirm('Are you sure you want to delete this menu item?')) return;
            
            try {
                await deleteMenuItemAPI(itemId);
                alert('Menu item deleted successfully!');
                loadMenuItems();
            } catch (error) {
                alert('Failed to delete menu item: ' + error.message);
            }
        }

        // Show loading
        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
            document.getElementById('menuTable').style.display = show ? 'none' : 'table';
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
    </style>
</body>
</html>