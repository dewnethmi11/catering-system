<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Bookings - Delight Catering</title>
</head>
<body>
    <div class="content-header">
        <h2>Event Bookings</h2>
        <p>Manage customer bookings and event schedules</p>
    </div>

    <!-- Filter and Search -->
    <div class="card">
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <input 
                type="text" 
                id="searchBooking" 
                class="form-control" 
                placeholder="Search by customer or venue..."
                style="flex: 1; min-width: 250px;"
                onkeyup="handleSearch()"
            >
            <select class="form-control" style="width: 180px;" onchange="filterByStatus(this.value)">
                <option value="">All Status</option>
                <option value="PENDING">Pending</option>
                <option value="CONFIRMED">Confirmed</option>
                <option value="COMPLETED">Completed</option>
                <option value="CANCELLED">Cancelled</option>
            </select>
            <button class="btn btn-primary" onclick="loadUpcomingBookings()">📅 Upcoming</button>
            <button class="btn btn-primary" onclick="openAddBookingModal()">➕ New Booking</button>
            <button class="btn btn-secondary" onclick="loadBookings()">🔄 Refresh</button>
        </div>
    </div>

    <!-- Bookings Table -->
    <div class="card">
        <h3 class="card-title">Booking List</h3>
        <div id="loadingMessage" style="text-align: center; padding: 40px; display: none;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #666;">Loading bookings...</p>
        </div>
        <div id="errorMessage" style="display: none; padding: 20px; background: #ffebee; color: #c62828; border-radius: 8px; margin-bottom: 20px;"></div>
        <div style="overflow-x: auto;">
            <table id="bookingsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Event Date</th>
                        <th>Venue</th>
                        <th>Package</th>
                        <th>Guests</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingsTableBody">
                    <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Booking Modal -->
    <div id="bookingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 10px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modalTitle">Create New Booking</h3>
                <button onclick="closeBookingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <form id="bookingForm">
                <input type="hidden" id="bookingId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Customer *</label>
                        <select id="customerId" class="form-control" required>
                            <option value="">Select customer...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Catering Package *</label>
                        <select id="packageId" class="form-control" required onchange="updatePackagePrice()">
                            <option value="">Select package...</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Event Date *</label>
                        <input type="datetime-local" id="eventDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Guest Count *</label>
                        <input type="number" id="guestCount" class="form-control" min="1" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Event Venue *</label>
                    <input type="text" id="eventVenue" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Venue Address</label>
                    <textarea id="venueAddress" class="form-control" rows="2"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Contact Person Name</label>
                        <input type="text" id="contactPersonName" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>Contact Person Phone</label>
                        <input type="tel" id="contactPersonPhone" class="form-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Special Requests</label>
                    <textarea id="specialRequests" class="form-control" rows="3" placeholder="Any special dietary requirements, setup preferences, etc."></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Total Amount (Rs) *</label>
                        <input type="number" id="totalAmount" class="form-control" step="0.01" min="0.01" required readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Advance Payment (Rs)</label>
                        <input type="number" id="advancePayment" class="form-control" step="0.01" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Status</label>
                        <select id="status" class="form-control">
                            <option value="PENDING">Pending</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <span id="submitBtnText">Create Booking</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeBookingModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allBookings = [];
        let filteredBookings = [];
        let currentEditId = null;
        let customers = [];
        let packages = [];

        // Load bookings on page load
        // window.addEventListener('DOMContentLoaded', function() {
        //     loadBookings();
        //     loadCustomers();
        //     loadPackages();
        // });

        // Call immediately - no need for DOMContentLoaded in dynamically loaded pages
        setTimeout(function() {
            if (typeof getAllUsersAPI === 'function') {
                loadBookings();
                loadCustomers();
                loadPackages();
            } else {
                console.error('API functions not loaded yet');
            }
        }, 100);

        // Load all bookings
        async function loadBookings() {
            showLoading(true);
            hideError();
            
            try {
                allBookings = await getAllBookingsAPI();
                filteredBookings = [...allBookings];
                renderBookings();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Failed to load bookings');
            }
        }

        // Load customers for dropdown
        async function loadCustomers() {
            try {
                const allUsers = await getAllUsersAPI();
                customers = allUsers.filter(u => u.role === 'CUSTOMER');
            } catch (error) {
                console.error('Failed to load customers:', error);
            }
        }

        // Load packages for dropdown
        async function loadPackages() {
            try {
                packages = await getAllPackagesAPI();
            } catch (error) {
                console.error('Failed to load packages:', error);
                // If packages endpoint doesn't exist, use dummy data
                packages = [
                    { id: 1, name: 'Wedding Package', basePrice: 2999 },
                    { id: 2, name: 'Corporate Event', basePrice: 1499 },
                    { id: 3, name: 'Birthday Party', basePrice: 799 }
                ];
            }
        }

        // Render bookings table
        function renderBookings() {
            const tbody = document.getElementById('bookingsTableBody');
            tbody.innerHTML = '';

            if (filteredBookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">No bookings found</td></tr>';
                return;
            }

            filteredBookings.forEach(booking => {
                const statusColor = {
                    'PENDING': 'orange',
                    'CONFIRMED': 'green',
                    'COMPLETED': 'blue',
                    'CANCELLED': 'red'
                };

                const customerName = booking.customer ? 
                    `${booking.customer.firstName} ${booking.customer.lastName}` : 
                    'Unknown';
                const packageName = booking.cateringPackage ? 
                    booking.cateringPackage.name : 
                    'N/A';

                const row = `
                    <tr>
                        <td><strong>#${booking.id}</strong></td>
                        <td>${customerName}</td>
                        <td>${new Date(booking.eventDate).toLocaleDateString()}</td>
                        <td>${booking.eventVenue}</td>
                        <td>${packageName}</td>
                        <td>${booking.guestCount}</td>
                        <td>Rs:${parseFloat(booking.totalAmount).toFixed(2)}</td>
                        <td>
                            <span style="color: ${statusColor[booking.status]};">●</span> 
                            ${booking.status}
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; margin-right: 5px;" onclick="viewBooking(${booking.id})">
                                View
                            </button>
                            ${booking.status === 'PENDING' ? `
                                <button class="btn btn-primary" style="padding: 5px 10px; margin-right: 5px;" onclick="confirmBooking(${booking.id})">
                                    Confirm
                                </button>
                            ` : ''}
                            ${booking.status !== 'CANCELLED' && booking.status !== 'COMPLETED' ? `
                                <button class="btn btn-danger" style="padding: 5px 10px;" onclick="cancelBooking(${booking.id})">
                                    Cancel
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Handle search
        function handleSearch() {
            const searchTerm = document.getElementById('searchBooking').value.toLowerCase();
            
            filteredBookings = allBookings.filter(booking => {
                const customerName = booking.customer ? 
                    `${booking.customer.firstName} ${booking.customer.lastName}`.toLowerCase() : '';
                const venue = booking.eventVenue.toLowerCase();
                
                return customerName.includes(searchTerm) || venue.includes(searchTerm);
            });
            
            renderBookings();
        }

        // Filter by status
        async function filterByStatus(status) {
            showLoading(true);
            hideError();
            
            try {
                if (status === '') {
                    filteredBookings = await getAllBookingsAPI();
                } else {
                    filteredBookings = await getBookingsByStatusAPI(status);
                }
                renderBookings();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Filter failed');
            }
        }

        // Load upcoming bookings
        async function loadUpcomingBookings() {
            showLoading(true);
            hideError();
            
            try {
                filteredBookings = await getUpcomingBookingsAPI();
                renderBookings();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Failed to load upcoming bookings');
            }
        }

        // Open add booking modal
        async function openAddBookingModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Create New Booking';
            document.getElementById('submitBtnText').textContent = 'Create Booking';
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingId').value = '';
            
            // Populate customer dropdown
            const customerSelect = document.getElementById('customerId');
            customerSelect.innerHTML = '<option value="">Select customer...</option>';
            customers.forEach(customer => {
                customerSelect.innerHTML += `<option value="${customer.id}">${customer.firstName} ${customer.lastName}</option>`;
            });
            
            // Populate package dropdown
            const packageSelect = document.getElementById('packageId');
            packageSelect.innerHTML = '<option value="">Select package...</option>';
            packages.forEach(pkg => {
                const price = pkg.basePrice || pkg.price || 0;
                packageSelect.innerHTML += `<option value="${pkg.id}" data-price="${price}">${pkg.name} - $${price}</option>`;
            });
            
            document.getElementById('bookingModal').style.display = 'flex';
        }

        // Update package price when package is selected
        function updatePackagePrice() {
            const packageSelect = document.getElementById('packageId');
            const selectedOption = packageSelect.options[packageSelect.selectedIndex];
            const price = selectedOption.getAttribute('data-price') || 0;
            document.getElementById('totalAmount').value = price;
        }

        // Close booking modal
        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
            document.getElementById('bookingForm').reset();
            currentEditId = null;
        }

        // View booking details
        async function viewBooking(bookingId) {
            try {
                const booking = await getBookingByIdAPI(bookingId);
                
                const customerName = booking.customer ? 
                    `${booking.customer.firstName} ${booking.customer.lastName}` : 
                    'Unknown';
                const packageName = booking.cateringPackage ? 
                    booking.cateringPackage.name : 
                    'N/A';

                const details = `
Booking Details
===============
Booking ID: #${booking.id}
Status: ${booking.status}

Customer Information
-------------------
Name: ${customerName}
Email: ${booking.customer?.email || 'N/A'}
Phone: ${booking.customer?.phoneNumber || 'N/A'}

Event Details
-------------
Date: ${new Date(booking.eventDate).toLocaleString()}
Venue: ${booking.eventVenue}
Address: ${booking.venueAddress || 'Not provided'}
Guests: ${booking.guestCount}

Package Information
------------------
Package: ${packageName}

Contact Person
-------------
Name: ${booking.contactPersonName || 'Not provided'}
Phone: ${booking.contactPersonPhone || 'Not provided'}

Financial Information
--------------------
Total Amount: Rs:${parseFloat(booking.totalAmount).toFixed(2)}
Advance Payment: Rs:${parseFloat(booking.advancePayment || 0).toFixed(2)}
Remaining: Rs:${parseFloat(booking.remainingPayment || 0).toFixed(2)}
Payment Status: ${booking.paymentStatus}

Special Requests
---------------
${booking.specialRequests || 'None'}

Booking Date: ${new Date(booking.createdAt).toLocaleDateString()}
                `;
                alert(details);
            } catch (error) {
                alert('Failed to load booking details: ' + error.message);
            }
        }

        // Handle form submission
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const eventDateInput = document.getElementById('eventDate').value;
            const eventDate = new Date(eventDateInput).toISOString();
            
            const bookingData = {
                customer: {
                    id: parseInt(document.getElementById('customerId').value)
                },
                cateringPackage: {
                    id: parseInt(document.getElementById('packageId').value)
                },
                eventDate: eventDate,
                eventVenue: document.getElementById('eventVenue').value.trim(),
                venueAddress: document.getElementById('venueAddress').value.trim(),
                guestCount: parseInt(document.getElementById('guestCount').value),
                contactPersonName: document.getElementById('contactPersonName').value.trim(),
                contactPersonPhone: document.getElementById('contactPersonPhone').value.trim(),
                specialRequests: document.getElementById('specialRequests').value.trim(),
                totalAmount: parseFloat(document.getElementById('totalAmount').value),
                advancePayment: parseFloat(document.getElementById('advancePayment').value) || 0,
                status: document.getElementById('status').value
            };

            const submitBtn = document.querySelector('#bookingForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';

            try {
                if (currentEditId) {
                    await updateBookingAPI(currentEditId, bookingData);
                    alert('Booking updated successfully!');
                } else {
                    await createBookingAPI(bookingData);
                    alert('Booking created successfully!');
                }
                
                closeBookingModal();
                loadBookings();
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = currentEditId ? 'Update Booking' : 'Create Booking';
            }
        });

        // Confirm booking
        async function confirmBooking(bookingId) {
            if (!confirm('Confirm this booking?')) return;
            
            try {
                await updateBookingStatusAPI(bookingId, 'CONFIRMED');
                alert('Booking confirmed!');
                loadBookings();
            } catch (error) {
                alert('Failed to confirm booking: ' + error.message);
            }
        }

        // Cancel booking
        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) return;
            
            try {
                await updateBookingStatusAPI(bookingId, 'CANCELLED');
                alert('Booking cancelled!');
                loadBookings();
            } catch (error) {
                alert('Failed to cancel booking: ' + error.message);
            }
        }

        // Show loading
        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
            document.getElementById('bookingsTable').style.display = show ? 'none' : 'table';
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
    </style>
</body>
</html>