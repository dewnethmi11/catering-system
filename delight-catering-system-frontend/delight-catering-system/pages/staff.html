<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Management - Delight Catering</title>
</head>
<body>
    <div class="content-header">
        <h2>Staff Management</h2>
        <p>Manage staff members, schedules, and assignments</p>
    </div>

    <!-- Filter and Search -->
    <div class="card">
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: space-between;">
            <div style="display: flex; gap: 15px;">
                <select class="form-control" style="width: 200px;" onchange="handleRoleFilter(this.value)">
                    <option value="">All Roles</option>
                    <option value="CHEF">Chef</option>
                    <option value="SOUS_CHEF">Sous Chef</option>
                    <option value="KITCHEN_ASSISTANT">Kitchen Assistant</option>
                    <option value="DRIVER">Driver</option>
                    <option value="SERVER">Server</option>
                    <option value="COORDINATOR">Event Coordinator</option>
                    <option value="MANAGER">Manager</option>
                </select>
                <select class="form-control" style="width: 200px;" onchange="handleStatusFilter(this.value)">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="available">Available</option>
                </select>
            </div>
            <div>
                <button class="btn btn-primary" onclick="openAddStaffModal()">➕ Add Staff Member</button>
                <button class="btn btn-secondary" onclick="loadStaff()">🔄 Refresh</button>
            </div>
        </div>
    </div>

    <!-- Staff Table -->
    <div class="card">
        <h3 class="card-title">Staff Members</h3>
        <div id="loadingMessage" style="text-align: center; padding: 40px; display: none;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 15px; color: #666;">Loading staff...</p>
        </div>
        <div id="errorMessage" style="display: none; padding: 20px; background: #ffebee; color: #c62828; border-radius: 8px; margin-bottom: 20px;"></div>
        <div style="overflow-x: auto;">
            <table id="staffTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Hourly Rate</th>
                        <th>Experience</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="staffTableBody">
                    <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Staff Modal -->
    <div id="staffModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 10px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modalTitle">Add New Staff Member</h3>
                <button onclick="closeStaffModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <form id="staffForm">
                <input type="hidden" id="staffId">
                
                <div class="form-group">
                    <label>Select User *</label>
                    <select id="userId" class="form-control" required>
                        <option value="">Select a user...</option>
                    </select>
                    <small style="color: #666; font-size: 12px;">Only users without staff profiles are shown</small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Staff Role *</label>
                        <select id="staffRole" class="form-control" required>
                            <option value="CHEF">Chef</option>
                            <option value="SOUS_CHEF">Sous Chef</option>
                            <option value="KITCHEN_ASSISTANT">Kitchen Assistant</option>
                            <option value="DRIVER">Driver</option>
                            <option value="SERVER">Server</option>
                            <option value="COORDINATOR">Event Coordinator</option>
                            <option value="MANAGER">Manager</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Hourly Rate (Rs) *</label>
                        <input type="number" id="hourlyRate" class="form-control" step="0.01" min="0.01" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Experience Years</label>
                        <input type="number" id="experienceYears" class="form-control" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Performance Rating (0-5)</label>
                        <input type="number" id="performanceRating" class="form-control" step="0.1" min="0" max="5" value="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Skills</label>
                    <textarea id="skills" class="form-control" rows="2" placeholder="e.g., Italian Cuisine, Fine Dining, Baking"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Qualifications</label>
                    <textarea id="qualifications" class="form-control" rows="2" placeholder="e.g., Culinary Arts Degree, Food Safety Certificate"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Emergency Contact Name</label>
                        <input type="text" id="emergencyContactName" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>Emergency Contact Phone</label>
                        <input type="tel" id="emergencyContactPhone" class="form-control">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Employment Status</label>
                        <select id="employmentStatus" class="form-control">
                            <option value="ACTIVE">Active</option>
                            <option value="ON_LEAVE">On Leave</option>
                            <option value="TERMINATED">Terminated</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 30px;">
                            <input type="checkbox" id="available" checked> Available for assignments
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <span id="submitBtnText">Create Staff Member</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeStaffModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allStaff = [];
        let filteredStaff = [];
        let currentEditId = null;
        let availableUsers = [];

        // Call immediately - no need for DOMContentLoaded in dynamically loaded pages
        setTimeout(function() {
            if (typeof getAllUsersAPI === 'function') {
                loadStaff();
                loadAvailableUsers();
            } else {
                console.error('API functions not loaded yet');
            }
        }, 100);

        // Load all staff
        async function loadStaff() {
            showLoading(true);
            hideError();
            
            try {
                allStaff = await getAllStaffAPI();
                filteredStaff = [...allStaff];
                renderStaff();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Failed to load staff');
            }
        }

        // Load available users (users without staff profiles)
        async function loadAvailableUsers() {
            try {
                const allUsers = await getAllUsersAPI();
                const staffUserIds = allStaff.map(s => s.user?.id);
                availableUsers = allUsers.filter(u => !staffUserIds.includes(u.id));
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        // Render staff table
        function renderStaff() {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '';

            if (filteredStaff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">No staff members found</td></tr>';
                return;
            }

            filteredStaff.forEach(staff => {
                const statusColor = {
                    'ACTIVE': 'green',
                    'ON_LEAVE': 'orange',
                    'TERMINATED': 'red'
                };

                const row = `
                    <tr>
                        <td>${staff.id}</td>
                        <td><strong>${staff.user?.firstName || ''} ${staff.user?.lastName || ''}</strong></td>
                        <td><span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${staff.staffRole}</span></td>
                        <td>${staff.user?.email || 'N/A'}</td>
                        <td>${staff.user?.phoneNumber || 'N/A'}</td>
                        <td>Rs ${parseFloat(staff.hourlyRate).toFixed(2)}/hr</td>
                        <td>${staff.experienceYears || 0} years</td>
                        <td>
                            <span style="color: ${statusColor[staff.employmentStatus]};">●</span>
                            ${staff.employmentStatus.replace('_', ' ')}</br>
                            ${staff.available ? 
                                '<span style="color: green; margin-left: 8px;">Available</span>' : 
                                '<span style="color: red; margin-left: 8px;">Unavailable</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; margin-right: 5px;" onclick="viewStaff(${staff.id})">
                                View
                            </button>
                            <button class="btn btn-secondary" style="padding: 5px 10px; margin-right: 5px;" onclick="editStaff(${staff.id})">
                                Edit
                            </button>
                            ${staff.available ? `
                                <button class="btn btn-danger" style="padding: 5px 10px;" onclick="toggleStaffAvailability(${staff.id})">
                                    Unavailable
                                </button>
                            ` : `
                                <button class="btn btn-primary" style="padding: 5px 10px;" onclick="toggleStaffAvailability(${staff.id})">
                                    Available
                                </button>
                            `}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Handle role filter
        async function handleRoleFilter(role) {
            showLoading(true);
            hideError();
            
            try {
                if (role === '') {
                    filteredStaff = await getAllStaffAPI();
                } else {
                    filteredStaff = await getStaffByRoleAPI(role);
                }
                renderStaff();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Filter failed');
            }
        }

        // Handle status filter
        async function handleStatusFilter(status) {
            showLoading(true);
            hideError();
            
            try {
                if (status === 'active') {
                    filteredStaff = await getActiveStaffAPI();
                } else if (status === 'available') {
                    filteredStaff = await getAvailableStaffAPI();
                } else {
                    filteredStaff = await getAllStaffAPI();
                }
                renderStaff();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                showError(error.message || 'Filter failed');
            }
        }

        // Open add staff modal
        async function openAddStaffModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add New Staff Member';
            document.getElementById('submitBtnText').textContent = 'Create Staff Member';
            document.getElementById('staffForm').reset();
            document.getElementById('staffId').value = '';
            
            // Load available users
            await loadAvailableUsers();
            const userSelect = document.getElementById('userId');
            userSelect.innerHTML = '<option value="">Select a user...</option>';
            availableUsers.forEach(user => {
                userSelect.innerHTML += `<option value="${user.id}">${user.firstName} ${user.lastName} (${user.email})</option>`;
            });
            
            document.getElementById('staffModal').style.display = 'flex';
        }

        // Close staff modal
        function closeStaffModal() {
            document.getElementById('staffModal').style.display = 'none';
            document.getElementById('staffForm').reset();
            currentEditId = null;
        }

        // View staff details
        async function viewStaff(staffId) {
            try {
                const staff = await getStaffByIdAPI(staffId);
                
                const details = `
Staff Details
=============
ID: ${staff.id}
Name: ${staff.user?.firstName || ''} ${staff.user?.lastName || ''}
Email: ${staff.user?.email || 'N/A'}
Phone: ${staff.user?.phoneNumber || 'N/A'}

Employment Information
---------------------
Role: ${staff.staffRole}
Hourly Rate: Rs ${parseFloat(staff.hourlyRate).toFixed(2)}
Experience: ${staff.experienceYears || 0} years
Status: ${staff.employmentStatus}
Available: ${staff.available ? 'Yes' : 'No'}
Hire Date: ${new Date(staff.hireDate).toLocaleDateString()}

Skills & Qualifications
----------------------
Skills: ${staff.skills || 'Not specified'}
Qualifications: ${staff.qualifications || 'Not specified'}
Performance Rating: ${parseFloat(staff.performanceRating || 0).toFixed(1)}/5.0

Emergency Contact
-----------------
Name: ${staff.emergencyContactName || 'Not provided'}
Phone: ${staff.emergencyContactPhone || 'Not provided'}
                `;
                alert(details);
            } catch (error) {
                alert('Failed to load staff details: ' + error.message);
            }
        }

        // Edit staff
        async function editStaff(staffId) {
            try {
                const staff = await getStaffByIdAPI(staffId);
                
                currentEditId = staffId;
                document.getElementById('modalTitle').textContent = 'Edit Staff Member';
                document.getElementById('submitBtnText').textContent = 'Update Staff Member';
                document.getElementById('staffId').value = staff.id;
                
                // User cannot be changed in edit mode
                const userSelect = document.getElementById('userId');
                userSelect.innerHTML = `<option value="${staff.user.id}">${staff.user.firstName} ${staff.user.lastName}</option>`;
                userSelect.disabled = true;
                
                document.getElementById('staffRole').value = staff.staffRole;
                document.getElementById('hourlyRate').value = staff.hourlyRate;
                document.getElementById('experienceYears').value = staff.experienceYears || 0;
                document.getElementById('performanceRating').value = staff.performanceRating || 0;
                document.getElementById('skills').value = staff.skills || '';
                document.getElementById('qualifications').value = staff.qualifications || '';
                document.getElementById('emergencyContactName').value = staff.emergencyContactName || '';
                document.getElementById('emergencyContactPhone').value = staff.emergencyContactPhone || '';
                document.getElementById('employmentStatus').value = staff.employmentStatus;
                document.getElementById('available').checked = staff.available;
                
                document.getElementById('staffModal').style.display = 'flex';
            } catch (error) {
                alert('Failed to load staff details: ' + error.message);
            }
        }

        // Handle form submission
        document.getElementById('staffForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const staffData = {
                user: {
                    id: document.getElementById('userId').value
                },
                staffRole: document.getElementById('staffRole').value,
                hourlyRate: parseFloat(document.getElementById('hourlyRate').value),
                experienceYears: parseInt(document.getElementById('experienceYears').value) || 0,
                performanceRating: parseFloat(document.getElementById('performanceRating').value) || 0,
                skills: document.getElementById('skills').value.trim(),
                qualifications: document.getElementById('qualifications').value.trim(),
                emergencyContactName: document.getElementById('emergencyContactName').value.trim(),
                emergencyContactPhone: document.getElementById('emergencyContactPhone').value.trim(),
                employmentStatus: document.getElementById('employmentStatus').value,
                available: document.getElementById('available').checked
            };

            const submitBtn = document.querySelector('#staffForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';

            try {
                if (currentEditId) {
                    await updateStaffAPI(currentEditId, staffData);
                    alert('Staff member updated successfully!');
                } else {
                    await createStaffAPI(staffData);
                    alert('Staff member created successfully!');
                }
                
                closeStaffModal();
                loadStaff();
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = currentEditId ? 'Update Staff Member' : 'Create Staff Member';
            }
        });

        // Toggle staff availability
        async function toggleStaffAvailability(staffId) {
            try {
                await toggleAvailabilityAPI(staffId);
                alert('Staff availability updated!');
                loadStaff();
            } catch (error) {
                alert('Failed to update availability: ' + error.message);
            }
        }

        // Show loading
        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
            document.getElementById('staffTable').style.display = show ? 'none' : 'table';
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
    </style>
</body>
</html>